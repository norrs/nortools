name: Release Desktop Linux amd64 Native

on:
  workflow_call:
    inputs:
      tag:
        description: "Release tag to publish (example: v0.1.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  release-linux-native:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag }}

      - name: Resolve release tag
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ inputs.tag }}"
          if [[ -z "${tag}" ]]; then
            echo "Release tag is required." >&2
            exit 1
          fi
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "artifact_name=nortools-linux-amd64-${tag}.tar.gz" >> "$GITHUB_OUTPUT"

      - name: Setup Bazelisk
        uses: bazelbuild/setup-bazelisk@v3

      - name: Setup GraalVM JDK 25 + native-image
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: "25"
          distribution: "graalvm"
          github-token: ${{ secrets.GITHUB_TOKEN }}
          native-image-job-reports: "true"

      - name: Install Linux native build dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            zlib1g-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev

      - name: Build native Linux archive
        shell: bash
        run: |
          set -euo pipefail
          bazelisk build //desktop:native-linux-amd64

      - name: Locate archive
        id: locate
        shell: bash
        run: |
          set -euo pipefail
          artifact="$(bazelisk cquery --output=files //desktop:native-linux-amd64 | head -n1)"
          if [[ -z "${artifact}" || ! -f "${artifact}" ]]; then
            echo "Could not locate built archive for //desktop:native-linux-amd64" >&2
            exit 1
          fi
          echo "artifact=${artifact}" >> "$GITHUB_OUTPUT"

      - name: Prepare release files
        id: package
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release
          cp "${{ steps.locate.outputs.artifact }}" "release/${{ steps.meta.outputs.artifact_name }}"
          sha256sum "release/${{ steps.meta.outputs.artifact_name }}" > "release/${{ steps.meta.outputs.artifact_name }}.sha256"
          echo "archive=release/${{ steps.meta.outputs.artifact_name }}" >> "$GITHUB_OUTPUT"
          echo "checksum=release/${{ steps.meta.outputs.artifact_name }}.sha256" >> "$GITHUB_OUTPUT"

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.artifact_name }}
          path: |
            ${{ steps.package.outputs.archive }}
            ${{ steps.package.outputs.checksum }}

      - name: Publish GitHub release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          files: |
            ${{ steps.package.outputs.archive }}
            ${{ steps.package.outputs.checksum }}
          fail_on_unmatched_files: true
